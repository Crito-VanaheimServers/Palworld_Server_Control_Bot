"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.diff = void 0;

var R = _interopRequireWildcard(require("ramda"));

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var checkValue = function checkValue(_ref) {
  var key = _ref.key,
      curr = _ref.curr,
      mod = _ref.mod;
  return R.equals(R.prop(key, curr), R.prop(key, mod)) ? R.prop(key, curr) : "".concat(R.prop(key, mod), " -> ").concat(R.prop(key, curr));
};

var getOkData = function getOkData(_ref2) {
  var val = _ref2.val,
      curr = _ref2.curr,
      mod = _ref2.mod;
  return R.map(function (k) {
    return _defineProperty({}, k, checkValue({
      key: k,
      curr: curr,
      mod: mod
    }));
  }, val);
};

var getPkData = function getPkData(_ref4) {
  var val = _ref4.val,
      data = _ref4.data;
  return R.map(function (k) {
    return _defineProperty({}, k, R.prop(k, data));
  }, val);
};

var mapDiff = function mapDiff(_ref6) {
  var curr = _ref6.curr,
      mod = _ref6.mod,
      primaryKeys = _ref6.primaryKeys,
      diffKeys = _ref6.diffKeys;
  var createPkDataCurr = getPkData({
    val: primaryKeys,
    data: curr
  });
  var createPkDataMod = getPkData({
    val: primaryKeys,
    data: mod
  });
  return R.equals(createPkDataCurr, createPkDataMod) ? R.pipe(function (val) {
    return getOkData({
      val: val,
      curr: curr,
      mod: mod
    });
  }, R.concat(createPkDataCurr), R.mergeAll)(diffKeys) : {};
};

var removeModified = function removeModified(_ref7) {
  var k = _ref7.k,
      pk = _ref7.pk,
      arr = _ref7.arr;
  return R.pipe(function (x) {
    return R.flatten(x);
  }, R.map(function (x) {
    return R.prop(pk, x);
  }), R.contains(R.prop(pk, k)), R.not)(arr);
};

var indexResult = function indexResult(_ref8) {
  var current = _ref8.current,
      pk = _ref8.pk,
      removed = _ref8.removed,
      added = _ref8.added,
      modified = _ref8.modified;
  return R.pipe(R.filter(function (k) {
    return removeModified({
      k: k,
      pk: pk,
      arr: [removed, added, modified]
    });
  }), R.concat([modified, added, removed]), R.flatten, R.sortBy(R.prop(pk)))(current);
};

var getColKeys = function getColKeys(list, primaryKeys) {
  return R.compose(R.filter(function (x) {
    return !R.contains(x, primaryKeys);
  }), R.keys)(list);
};

var diff = function diff(_ref9) {
  var prev = _ref9.prev,
      current = _ref9.current,
      primaryKeys = _ref9.primaryKeys,
      diffKeys = _ref9.diffKeys,
      indexed = _ref9.indexed;

  var cmp = function cmp(x, y) {
    return R.all(function (z) {
      return R.eqProps(z, x, y);
    }, primaryKeys);
  };

  var currentChages = R.difference(current, prev);
  var previousChages = R.difference(prev, current);
  var removes = R.differenceWith(cmp, previousChages, currentChages);
  var adds = R.differenceWith(cmp, currentChages, previousChages);
  var previousVals = R.difference(previousChages, removes);
  var statusModifiedPrevious = R.map(R.assoc("@@", "->"))(previousVals);

  var diffItem = function diffItem(curr) {
    return R.map(function (mod) {
      return mapDiff({
        curr: curr,
        mod: mod,
        primaryKeys: primaryKeys,
        diffKeys: R.isNil(diffKeys) ? getColKeys(mod, primaryKeys) : diffKeys
      });
    }, statusModifiedPrevious);
  };

  var statusAdded = R.map(R.assoc("@@", "+++"))(adds);
  var statusRemoved = R.map(R.assoc("@@", "---"))(removes);
  var addRemoveArray = R.concat(statusAdded, statusRemoved);
  var modified = R.filter(R.compose(R.not, R.isEmpty), R.flatten(R.map(diffItem, current)));
  return indexed ? indexResult({
    current: current,
    pk: R.head(primaryKeys),
    removed: statusRemoved,
    added: statusAdded,
    modified: modified
  }) : R.concat(modified, addRemoveArray);
};

exports.diff = diff;
var _default = diff;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9kaWZmL2RpZmYudHMiXSwibmFtZXMiOlsiY2hlY2tWYWx1ZSIsImtleSIsImN1cnIiLCJtb2QiLCJSIiwiZXF1YWxzIiwicHJvcCIsImdldE9rRGF0YSIsInZhbCIsIm1hcCIsImsiLCJnZXRQa0RhdGEiLCJkYXRhIiwibWFwRGlmZiIsInByaW1hcnlLZXlzIiwiZGlmZktleXMiLCJjcmVhdGVQa0RhdGFDdXJyIiwiY3JlYXRlUGtEYXRhTW9kIiwicGlwZSIsImNvbmNhdCIsIm1lcmdlQWxsIiwicmVtb3ZlTW9kaWZpZWQiLCJwayIsImFyciIsIngiLCJmbGF0dGVuIiwiY29udGFpbnMiLCJub3QiLCJpbmRleFJlc3VsdCIsImN1cnJlbnQiLCJyZW1vdmVkIiwiYWRkZWQiLCJtb2RpZmllZCIsImZpbHRlciIsInNvcnRCeSIsImdldENvbEtleXMiLCJsaXN0IiwiY29tcG9zZSIsImtleXMiLCJkaWZmIiwicHJldiIsImluZGV4ZWQiLCJjbXAiLCJ5IiwiYWxsIiwieiIsImVxUHJvcHMiLCJjdXJyZW50Q2hhZ2VzIiwiZGlmZmVyZW5jZSIsInByZXZpb3VzQ2hhZ2VzIiwicmVtb3ZlcyIsImRpZmZlcmVuY2VXaXRoIiwiYWRkcyIsInByZXZpb3VzVmFscyIsInN0YXR1c01vZGlmaWVkUHJldmlvdXMiLCJhc3NvYyIsImRpZmZJdGVtIiwiaXNOaWwiLCJzdGF0dXNBZGRlZCIsInN0YXR1c1JlbW92ZWQiLCJhZGRSZW1vdmVBcnJheSIsImlzRW1wdHkiLCJoZWFkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7OztBQUVBLElBQU1BLFVBQVUsR0FBRyxTQUFiQSxVQUFhO0FBQUEsTUFBR0MsR0FBSCxRQUFHQSxHQUFIO0FBQUEsTUFBUUMsSUFBUixRQUFRQSxJQUFSO0FBQUEsTUFBY0MsR0FBZCxRQUFjQSxHQUFkO0FBQUEsU0FDakJDLENBQUMsQ0FBQ0MsTUFBRixDQUFTRCxDQUFDLENBQUNFLElBQUYsQ0FBT0wsR0FBUCxFQUFZQyxJQUFaLENBQVQsRUFBNEJFLENBQUMsQ0FBQ0UsSUFBRixDQUFPTCxHQUFQLEVBQVlFLEdBQVosQ0FBNUIsSUFDSUMsQ0FBQyxDQUFDRSxJQUFGLENBQU9MLEdBQVAsRUFBWUMsSUFBWixDQURKLGFBRU9FLENBQUMsQ0FBQ0UsSUFBRixDQUFPTCxHQUFQLEVBQVlFLEdBQVosQ0FGUCxpQkFFOEJDLENBQUMsQ0FBQ0UsSUFBRixDQUFPTCxHQUFQLEVBQVlDLElBQVosQ0FGOUIsQ0FEaUI7QUFBQSxDQUFuQjs7QUFLQSxJQUFNSyxTQUFTLEdBQUcsU0FBWkEsU0FBWTtBQUFBLE1BQUdDLEdBQUgsU0FBR0EsR0FBSDtBQUFBLE1BQVFOLElBQVIsU0FBUUEsSUFBUjtBQUFBLE1BQWNDLEdBQWQsU0FBY0EsR0FBZDtBQUFBLFNBQ2hCQyxDQUFDLENBQUNLLEdBQUYsQ0FDRSxVQUFBQyxDQUFDO0FBQUEsK0JBQ0VBLENBREYsRUFDTVYsVUFBVSxDQUFDO0FBQUVDLE1BQUFBLEdBQUcsRUFBRVMsQ0FBUDtBQUFVUixNQUFBQSxJQUFJLEVBQUpBLElBQVY7QUFBZ0JDLE1BQUFBLEdBQUcsRUFBSEE7QUFBaEIsS0FBRCxDQURoQjtBQUFBLEdBREgsRUFJRUssR0FKRixDQURnQjtBQUFBLENBQWxCOztBQVFBLElBQU1HLFNBQVMsR0FBRyxTQUFaQSxTQUFZO0FBQUEsTUFBR0gsR0FBSCxTQUFHQSxHQUFIO0FBQUEsTUFBUUksSUFBUixTQUFRQSxJQUFSO0FBQUEsU0FDaEJSLENBQUMsQ0FBQ0ssR0FBRixDQUNFLFVBQUFDLENBQUM7QUFBQSwrQkFDRUEsQ0FERixFQUNNTixDQUFDLENBQUNFLElBQUYsQ0FBT0ksQ0FBUCxFQUFVRSxJQUFWLENBRE47QUFBQSxHQURILEVBSUVKLEdBSkYsQ0FEZ0I7QUFBQSxDQUFsQjs7QUFRQSxJQUFNSyxPQUFPLEdBQUcsU0FBVkEsT0FBVSxRQVVWO0FBQUEsTUFUSlgsSUFTSSxTQVRKQSxJQVNJO0FBQUEsTUFSSkMsR0FRSSxTQVJKQSxHQVFJO0FBQUEsTUFQSlcsV0FPSSxTQVBKQSxXQU9JO0FBQUEsTUFOSkMsUUFNSSxTQU5KQSxRQU1JO0FBQ0osTUFBTUMsZ0JBQWdCLEdBQUdMLFNBQVMsQ0FBQztBQUFFSCxJQUFBQSxHQUFHLEVBQUVNLFdBQVA7QUFBb0JGLElBQUFBLElBQUksRUFBRVY7QUFBMUIsR0FBRCxDQUFsQztBQUNBLE1BQU1lLGVBQWUsR0FBR04sU0FBUyxDQUFDO0FBQUVILElBQUFBLEdBQUcsRUFBRU0sV0FBUDtBQUFvQkYsSUFBQUEsSUFBSSxFQUFFVDtBQUExQixHQUFELENBQWpDO0FBRUEsU0FBT0MsQ0FBQyxDQUFDQyxNQUFGLENBQVNXLGdCQUFULEVBQTJCQyxlQUEzQixJQUNIYixDQUFDLENBQUNjLElBQUYsQ0FDRSxVQUFDVixHQUFEO0FBQUEsV0FBY0QsU0FBUyxDQUFDO0FBQUVDLE1BQUFBLEdBQUcsRUFBSEEsR0FBRjtBQUFPTixNQUFBQSxJQUFJLEVBQUpBLElBQVA7QUFBYUMsTUFBQUEsR0FBRyxFQUFIQTtBQUFiLEtBQUQsQ0FBdkI7QUFBQSxHQURGLEVBRUVDLENBQUMsQ0FBQ2UsTUFBRixDQUFTSCxnQkFBVCxDQUZGLEVBR0VaLENBQUMsQ0FBQ2dCLFFBSEosRUFJRUwsUUFKRixDQURHLEdBTUgsRUFOSjtBQU9ELENBckJEOztBQXVCQSxJQUFNTSxjQUFjLEdBQUcsU0FBakJBLGNBQWlCO0FBQUEsTUFBR1gsQ0FBSCxTQUFHQSxDQUFIO0FBQUEsTUFBTVksRUFBTixTQUFNQSxFQUFOO0FBQUEsTUFBVUMsR0FBVixTQUFVQSxHQUFWO0FBQUEsU0FDckJuQixDQUFDLENBQUNjLElBQUYsQ0FDRSxVQUFDTSxDQUFEO0FBQUEsV0FBWXBCLENBQUMsQ0FBQ3FCLE9BQUYsQ0FBVUQsQ0FBVixDQUFaO0FBQUEsR0FERixFQUVFcEIsQ0FBQyxDQUFDSyxHQUFGLENBQU0sVUFBQ2UsQ0FBRDtBQUFBLFdBQVlwQixDQUFDLENBQUNFLElBQUYsQ0FBT2dCLEVBQVAsRUFBV0UsQ0FBWCxDQUFaO0FBQUEsR0FBTixDQUZGLEVBR0VwQixDQUFDLENBQUNzQixRQUFGLENBQVd0QixDQUFDLENBQUNFLElBQUYsQ0FBT2dCLEVBQVAsRUFBV1osQ0FBWCxDQUFYLENBSEYsRUFJRU4sQ0FBQyxDQUFDdUIsR0FKSixFQUtFSixHQUxGLENBRHFCO0FBQUEsQ0FBdkI7O0FBUUEsSUFBTUssV0FBVyxHQUFHLFNBQWRBLFdBQWM7QUFBQSxNQUNsQkMsT0FEa0IsU0FDbEJBLE9BRGtCO0FBQUEsTUFFbEJQLEVBRmtCLFNBRWxCQSxFQUZrQjtBQUFBLE1BR2xCUSxPQUhrQixTQUdsQkEsT0FIa0I7QUFBQSxNQUlsQkMsS0FKa0IsU0FJbEJBLEtBSmtCO0FBQUEsTUFLbEJDLFFBTGtCLFNBS2xCQSxRQUxrQjtBQUFBLFNBYWxCNUIsQ0FBQyxDQUFDYyxJQUFGLENBQ0VkLENBQUMsQ0FBQzZCLE1BQUYsQ0FBbUIsVUFBQXZCLENBQUM7QUFBQSxXQUNsQlcsY0FBYyxDQUFDO0FBQUVYLE1BQUFBLENBQUMsRUFBREEsQ0FBRjtBQUFLWSxNQUFBQSxFQUFFLEVBQUZBLEVBQUw7QUFBU0MsTUFBQUEsR0FBRyxFQUFFLENBQUNPLE9BQUQsRUFBVUMsS0FBVixFQUFpQkMsUUFBakI7QUFBZCxLQUFELENBREk7QUFBQSxHQUFwQixDQURGLEVBSUU1QixDQUFDLENBQUNlLE1BQUYsQ0FBUyxDQUFDYSxRQUFELEVBQVdELEtBQVgsRUFBa0JELE9BQWxCLENBQVQsQ0FKRixFQUtFMUIsQ0FBQyxDQUFDcUIsT0FMSixFQU1FckIsQ0FBQyxDQUFDOEIsTUFBRixDQUFTOUIsQ0FBQyxDQUFDRSxJQUFGLENBQU9nQixFQUFQLENBQVQsQ0FORixFQU9FTyxPQVBGLENBYmtCO0FBQUEsQ0FBcEI7O0FBc0JBLElBQU1NLFVBQVUsR0FBRyxTQUFiQSxVQUFhLENBQUNDLElBQUQsRUFBWXRCLFdBQVo7QUFBQSxTQUNqQlYsQ0FBQyxDQUFDaUMsT0FBRixDQUNFakMsQ0FBQyxDQUFDNkIsTUFBRixDQUFtQixVQUFBVCxDQUFDO0FBQUEsV0FBSSxDQUFDcEIsQ0FBQyxDQUFDc0IsUUFBRixDQUFXRixDQUFYLEVBQWNWLFdBQWQsQ0FBTDtBQUFBLEdBQXBCLENBREYsRUFFRVYsQ0FBQyxDQUFDa0MsSUFGSixFQUdFRixJQUhGLENBRGlCO0FBQUEsQ0FBbkI7O0FBTU8sSUFBTUcsSUFBSSxHQUFHLFNBQVBBLElBQU8sUUFZZDtBQUFBLE1BWEpDLElBV0ksU0FYSkEsSUFXSTtBQUFBLE1BVkpYLE9BVUksU0FWSkEsT0FVSTtBQUFBLE1BVEpmLFdBU0ksU0FUSkEsV0FTSTtBQUFBLE1BUkpDLFFBUUksU0FSSkEsUUFRSTtBQUFBLE1BUEowQixPQU9JLFNBUEpBLE9BT0k7O0FBQ0osTUFBTUMsR0FBRyxHQUFHLFNBQU5BLEdBQU0sQ0FBQ2xCLENBQUQsRUFBU21CLENBQVQ7QUFBQSxXQUNWdkMsQ0FBQyxDQUFDd0MsR0FBRixDQUFNLFVBQUNDLENBQUQ7QUFBQSxhQUFZekMsQ0FBQyxDQUFDMEMsT0FBRixDQUFVRCxDQUFWLEVBQWFyQixDQUFiLEVBQWdCbUIsQ0FBaEIsQ0FBWjtBQUFBLEtBQU4sRUFBc0M3QixXQUF0QyxDQURVO0FBQUEsR0FBWjs7QUFHQSxNQUFNaUMsYUFBYSxHQUFHM0MsQ0FBQyxDQUFDNEMsVUFBRixDQUFhbkIsT0FBYixFQUFzQlcsSUFBdEIsQ0FBdEI7QUFDQSxNQUFNUyxjQUFjLEdBQUc3QyxDQUFDLENBQUM0QyxVQUFGLENBQWFSLElBQWIsRUFBbUJYLE9BQW5CLENBQXZCO0FBQ0EsTUFBTXFCLE9BQU8sR0FBRzlDLENBQUMsQ0FBQytDLGNBQUYsQ0FBaUJULEdBQWpCLEVBQXNCTyxjQUF0QixFQUFzQ0YsYUFBdEMsQ0FBaEI7QUFDQSxNQUFNSyxJQUFJLEdBQUdoRCxDQUFDLENBQUMrQyxjQUFGLENBQWlCVCxHQUFqQixFQUFzQkssYUFBdEIsRUFBcUNFLGNBQXJDLENBQWI7QUFDQSxNQUFNSSxZQUFZLEdBQUdqRCxDQUFDLENBQUM0QyxVQUFGLENBQWFDLGNBQWIsRUFBNkJDLE9BQTdCLENBQXJCO0FBQ0EsTUFBTUksc0JBQXNCLEdBQUdsRCxDQUFDLENBQUNLLEdBQUYsQ0FBTUwsQ0FBQyxDQUFDbUQsS0FBRixDQUFRLElBQVIsRUFBYyxJQUFkLENBQU4sRUFBMkJGLFlBQTNCLENBQS9COztBQUNBLE1BQU1HLFFBQVEsR0FBRyxTQUFYQSxRQUFXLENBQUN0RCxJQUFEO0FBQUEsV0FDZkUsQ0FBQyxDQUFDSyxHQUFGLENBQ0UsVUFBQU4sR0FBRztBQUFBLGFBQ0RVLE9BQU8sQ0FBQztBQUNOWCxRQUFBQSxJQUFJLEVBQUpBLElBRE07QUFFTkMsUUFBQUEsR0FBRyxFQUFIQSxHQUZNO0FBR05XLFFBQUFBLFdBQVcsRUFBWEEsV0FITTtBQUlOQyxRQUFBQSxRQUFRLEVBQUVYLENBQUMsQ0FBQ3FELEtBQUYsQ0FBUTFDLFFBQVIsSUFBb0JvQixVQUFVLENBQUNoQyxHQUFELEVBQU1XLFdBQU4sQ0FBOUIsR0FBbURDO0FBSnZELE9BQUQsQ0FETjtBQUFBLEtBREwsRUFRRXVDLHNCQVJGLENBRGU7QUFBQSxHQUFqQjs7QUFZQSxNQUFNSSxXQUFXLEdBQUd0RCxDQUFDLENBQUNLLEdBQUYsQ0FBTUwsQ0FBQyxDQUFDbUQsS0FBRixDQUFRLElBQVIsRUFBYyxLQUFkLENBQU4sRUFBNEJILElBQTVCLENBQXBCO0FBQ0EsTUFBTU8sYUFBYSxHQUFHdkQsQ0FBQyxDQUFDSyxHQUFGLENBQU1MLENBQUMsQ0FBQ21ELEtBQUYsQ0FBUSxJQUFSLEVBQWMsS0FBZCxDQUFOLEVBQTRCTCxPQUE1QixDQUF0QjtBQUVBLE1BQU1VLGNBQWMsR0FBR3hELENBQUMsQ0FBQ2UsTUFBRixDQUFTdUMsV0FBVCxFQUFzQkMsYUFBdEIsQ0FBdkI7QUFDQSxNQUFNM0IsUUFBUSxHQUFHNUIsQ0FBQyxDQUFDNkIsTUFBRixDQUNmN0IsQ0FBQyxDQUFDaUMsT0FBRixDQUNFakMsQ0FBQyxDQUFDdUIsR0FESixFQUVFdkIsQ0FBQyxDQUFDeUQsT0FGSixDQURlLEVBS2Z6RCxDQUFDLENBQUNxQixPQUFGLENBQVVyQixDQUFDLENBQUNLLEdBQUYsQ0FBTStDLFFBQU4sRUFBZ0IzQixPQUFoQixDQUFWLENBTGUsQ0FBakI7QUFRQSxTQUFPWSxPQUFPLEdBQ1ZiLFdBQVcsQ0FBQztBQUNWQyxJQUFBQSxPQUFPLEVBQVBBLE9BRFU7QUFFVlAsSUFBQUEsRUFBRSxFQUFFbEIsQ0FBQyxDQUFDMEQsSUFBRixDQUFPaEQsV0FBUCxDQUZNO0FBR1ZnQixJQUFBQSxPQUFPLEVBQUU2QixhQUhDO0FBSVY1QixJQUFBQSxLQUFLLEVBQUUyQixXQUpHO0FBS1YxQixJQUFBQSxRQUFRLEVBQVJBO0FBTFUsR0FBRCxDQURELEdBUVY1QixDQUFDLENBQUNlLE1BQUYsQ0FBU2EsUUFBVCxFQUFtQjRCLGNBQW5CLENBUko7QUFTRCxDQXZETTs7O2VBeURRckIsSSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFIgZnJvbSBcInJhbWRhXCI7XHJcblxyXG5jb25zdCBjaGVja1ZhbHVlID0gKHsga2V5LCBjdXJyLCBtb2QgfTogeyBrZXk6IHN0cmluZzsgY3VycjogYW55OyBtb2Q6IGFueSB9KSA9PlxyXG4gIFIuZXF1YWxzKFIucHJvcChrZXksIGN1cnIpLCBSLnByb3Aoa2V5LCBtb2QpKVxyXG4gICAgPyBSLnByb3Aoa2V5LCBjdXJyKVxyXG4gICAgOiBgJHtSLnByb3Aoa2V5LCBtb2QpfSAtPiAke1IucHJvcChrZXksIGN1cnIpfWA7XHJcblxyXG5jb25zdCBnZXRPa0RhdGEgPSAoeyB2YWwsIGN1cnIsIG1vZCB9OiB7IHZhbDogYW55OyBjdXJyOiBhbnk7IG1vZDogYW55IH0pID0+XHJcbiAgUi5tYXAoXHJcbiAgICBrID0+ICh7XHJcbiAgICAgIFtrXTogY2hlY2tWYWx1ZSh7IGtleTogaywgY3VyciwgbW9kIH0pXHJcbiAgICB9KSxcclxuICAgIHZhbFxyXG4gICk7XHJcblxyXG5jb25zdCBnZXRQa0RhdGEgPSAoeyB2YWwsIGRhdGEgfTogeyB2YWw6IGFueTsgZGF0YTogYW55IH0pID0+XHJcbiAgUi5tYXAoXHJcbiAgICBrID0+ICh7XHJcbiAgICAgIFtrXTogUi5wcm9wKGssIGRhdGEpXHJcbiAgICB9KSxcclxuICAgIHZhbFxyXG4gICk7XHJcblxyXG5jb25zdCBtYXBEaWZmID0gKHtcclxuICBjdXJyLFxyXG4gIG1vZCxcclxuICBwcmltYXJ5S2V5cyxcclxuICBkaWZmS2V5c1xyXG59OiB7XHJcbiAgY3VycjogYW55O1xyXG4gIG1vZDogYW55O1xyXG4gIHByaW1hcnlLZXlzOiBhbnk7XHJcbiAgZGlmZktleXM6IGFueTtcclxufSkgPT4ge1xyXG4gIGNvbnN0IGNyZWF0ZVBrRGF0YUN1cnIgPSBnZXRQa0RhdGEoeyB2YWw6IHByaW1hcnlLZXlzLCBkYXRhOiBjdXJyIH0pO1xyXG4gIGNvbnN0IGNyZWF0ZVBrRGF0YU1vZCA9IGdldFBrRGF0YSh7IHZhbDogcHJpbWFyeUtleXMsIGRhdGE6IG1vZCB9KTtcclxuXHJcbiAgcmV0dXJuIFIuZXF1YWxzKGNyZWF0ZVBrRGF0YUN1cnIsIGNyZWF0ZVBrRGF0YU1vZClcclxuICAgID8gUi5waXBlKFxyXG4gICAgICAgICh2YWw6IGFueSkgPT4gZ2V0T2tEYXRhKHsgdmFsLCBjdXJyLCBtb2QgfSksXHJcbiAgICAgICAgUi5jb25jYXQoY3JlYXRlUGtEYXRhQ3VyciksXHJcbiAgICAgICAgUi5tZXJnZUFsbFxyXG4gICAgICApKGRpZmZLZXlzKVxyXG4gICAgOiB7fTtcclxufTtcclxuXHJcbmNvbnN0IHJlbW92ZU1vZGlmaWVkID0gKHsgaywgcGssIGFyciB9OiB7IGs6IGFueTsgcGs6IGFueTsgYXJyOiBhbnkgfSkgPT5cclxuICBSLnBpcGUoXHJcbiAgICAoeDogYW55KSA9PiBSLmZsYXR0ZW4oeCksXHJcbiAgICBSLm1hcCgoeDogYW55KSA9PiBSLnByb3AocGssIHgpKSxcclxuICAgIFIuY29udGFpbnMoUi5wcm9wKHBrLCBrKSksXHJcbiAgICBSLm5vdFxyXG4gICkoYXJyKTtcclxuXHJcbmNvbnN0IGluZGV4UmVzdWx0ID0gKHtcclxuICBjdXJyZW50LFxyXG4gIHBrLFxyXG4gIHJlbW92ZWQsXHJcbiAgYWRkZWQsXHJcbiAgbW9kaWZpZWRcclxufToge1xyXG4gIGN1cnJlbnQ6IGFueTtcclxuICBwazogYW55O1xyXG4gIHJlbW92ZWQ6IGFueTtcclxuICBhZGRlZDogYW55O1xyXG4gIG1vZGlmaWVkOiBhbnk7XHJcbn0pID0+XHJcbiAgUi5waXBlKFxyXG4gICAgUi5maWx0ZXI8YW55LCBhbnk+KGsgPT5cclxuICAgICAgcmVtb3ZlTW9kaWZpZWQoeyBrLCBwaywgYXJyOiBbcmVtb3ZlZCwgYWRkZWQsIG1vZGlmaWVkXSB9KVxyXG4gICAgKSxcclxuICAgIFIuY29uY2F0KFttb2RpZmllZCwgYWRkZWQsIHJlbW92ZWRdKSxcclxuICAgIFIuZmxhdHRlbixcclxuICAgIFIuc29ydEJ5KFIucHJvcChwaykpXHJcbiAgKShjdXJyZW50KTtcclxuXHJcbmNvbnN0IGdldENvbEtleXMgPSAobGlzdDogYW55LCBwcmltYXJ5S2V5czogYW55KSA9PlxyXG4gIFIuY29tcG9zZShcclxuICAgIFIuZmlsdGVyPGFueSwgYW55Pih4ID0+ICFSLmNvbnRhaW5zKHgsIHByaW1hcnlLZXlzKSksXHJcbiAgICBSLmtleXNcclxuICApKGxpc3QpO1xyXG5cclxuZXhwb3J0IGNvbnN0IGRpZmYgPSAoe1xyXG4gIHByZXYsXHJcbiAgY3VycmVudCxcclxuICBwcmltYXJ5S2V5cyxcclxuICBkaWZmS2V5cyxcclxuICBpbmRleGVkXHJcbn06IHtcclxuICBwcmV2OiBhbnk7XHJcbiAgY3VycmVudDogYW55O1xyXG4gIHByaW1hcnlLZXlzPzogYW55O1xyXG4gIGRpZmZLZXlzPzogYW55O1xyXG4gIGluZGV4ZWQ/OiBhbnk7XHJcbn0pID0+IHtcclxuICBjb25zdCBjbXAgPSAoeDogYW55LCB5OiBhbnkpID0+XHJcbiAgICBSLmFsbCgoejogYW55KSA9PiBSLmVxUHJvcHMoeiwgeCwgeSksIHByaW1hcnlLZXlzKTtcclxuXHJcbiAgY29uc3QgY3VycmVudENoYWdlcyA9IFIuZGlmZmVyZW5jZShjdXJyZW50LCBwcmV2KTtcclxuICBjb25zdCBwcmV2aW91c0NoYWdlcyA9IFIuZGlmZmVyZW5jZShwcmV2LCBjdXJyZW50KTtcclxuICBjb25zdCByZW1vdmVzID0gUi5kaWZmZXJlbmNlV2l0aChjbXAsIHByZXZpb3VzQ2hhZ2VzLCBjdXJyZW50Q2hhZ2VzKTtcclxuICBjb25zdCBhZGRzID0gUi5kaWZmZXJlbmNlV2l0aChjbXAsIGN1cnJlbnRDaGFnZXMsIHByZXZpb3VzQ2hhZ2VzKTtcclxuICBjb25zdCBwcmV2aW91c1ZhbHMgPSBSLmRpZmZlcmVuY2UocHJldmlvdXNDaGFnZXMsIHJlbW92ZXMpO1xyXG4gIGNvbnN0IHN0YXR1c01vZGlmaWVkUHJldmlvdXMgPSBSLm1hcChSLmFzc29jKFwiQEBcIiwgXCItPlwiKSkocHJldmlvdXNWYWxzKTtcclxuICBjb25zdCBkaWZmSXRlbSA9IChjdXJyOiBhbnkpID0+XHJcbiAgICBSLm1hcChcclxuICAgICAgbW9kID0+XHJcbiAgICAgICAgbWFwRGlmZih7XHJcbiAgICAgICAgICBjdXJyLFxyXG4gICAgICAgICAgbW9kLFxyXG4gICAgICAgICAgcHJpbWFyeUtleXMsXHJcbiAgICAgICAgICBkaWZmS2V5czogUi5pc05pbChkaWZmS2V5cykgPyBnZXRDb2xLZXlzKG1vZCwgcHJpbWFyeUtleXMpIDogZGlmZktleXNcclxuICAgICAgICB9KSxcclxuICAgICAgc3RhdHVzTW9kaWZpZWRQcmV2aW91c1xyXG4gICAgKTtcclxuXHJcbiAgY29uc3Qgc3RhdHVzQWRkZWQgPSBSLm1hcChSLmFzc29jKFwiQEBcIiwgXCIrKytcIikpKGFkZHMpO1xyXG4gIGNvbnN0IHN0YXR1c1JlbW92ZWQgPSBSLm1hcChSLmFzc29jKFwiQEBcIiwgXCItLS1cIikpKHJlbW92ZXMpO1xyXG5cclxuICBjb25zdCBhZGRSZW1vdmVBcnJheSA9IFIuY29uY2F0KHN0YXR1c0FkZGVkLCBzdGF0dXNSZW1vdmVkKTtcclxuICBjb25zdCBtb2RpZmllZCA9IFIuZmlsdGVyKFxyXG4gICAgUi5jb21wb3NlKFxyXG4gICAgICBSLm5vdCxcclxuICAgICAgUi5pc0VtcHR5XHJcbiAgICApLFxyXG4gICAgUi5mbGF0dGVuKFIubWFwKGRpZmZJdGVtLCBjdXJyZW50KSlcclxuICApO1xyXG5cclxuICByZXR1cm4gaW5kZXhlZFxyXG4gICAgPyBpbmRleFJlc3VsdCh7XHJcbiAgICAgICAgY3VycmVudCxcclxuICAgICAgICBwazogUi5oZWFkKHByaW1hcnlLZXlzKSxcclxuICAgICAgICByZW1vdmVkOiBzdGF0dXNSZW1vdmVkLFxyXG4gICAgICAgIGFkZGVkOiBzdGF0dXNBZGRlZCxcclxuICAgICAgICBtb2RpZmllZFxyXG4gICAgICB9KVxyXG4gICAgOiBSLmNvbmNhdChtb2RpZmllZCwgYWRkUmVtb3ZlQXJyYXkpO1xyXG59O1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZGlmZjtcclxuIl19