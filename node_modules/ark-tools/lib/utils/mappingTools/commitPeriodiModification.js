"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commitPeriodiModification = void 0;

var R = _interopRequireWildcard(require("ramda"));

var _sanctuary = require("sanctuary");

var _commitModsHelper = require("./commitModsHelper");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

var checkPrimaryKey = function checkPrimaryKey(_ref) {
  var row = _ref.row,
      pks = _ref.pks;
  return R.allPass(R.map(R.eqProps, pks))(row);
};

var alterMatch = R.curry(function (fn, state, row, pks) {
  return R.map(R.ifElse(checkPrimaryKey({
    row: row,
    pks: pks
  }), fn, R.identity), state);
});

var nonPrimaryKeyValuesAltered = function nonPrimaryKeyValuesAltered(modalData, pks, errMsg) {
  return R.equals(R.omit(pks, modalData.row), R.omit(pks, modalData.orig)) ? (0, _sanctuary.Left)(errMsg) : (0, _sanctuary.Right)(modalData);
};

var mapRanges = function mapRanges(list) {
  return list.map(function (row) {
    return (0, _commitModsHelper.moment)().range((0, _commitModsHelper.moment)(row.validoDal).format("YYYY-MM-DD"), (0, _commitModsHelper.moment)(row.validoAl).format("YYYY-MM-DD"));
  });
};

var periodiRangeOverlapChecker = function periodiRangeOverlapChecker(_ref2) {
  var tableData = _ref2.tableData,
      modalData = _ref2.modalData,
      selectedPeriodo = _ref2.selectedPeriodo,
      periodo = _ref2.periodo,
      periodoKeys = _ref2.periodoKeys,
      periodoErrorMsg = _ref2.periodoErrorMsg;
  var getSelectedRange = periodo.filter(function (row) {
    return row.periodo === selectedPeriodo;
  }).map(function (x) {
    return (0, _commitModsHelper.moment)().range(x.validoDal, x.validoAl);
  });
  var matchingDataPeriodo = tableData.filter(checkPrimaryKey({
    row: modalData.row,
    pks: periodoKeys
  })).map(function (x) {
    return x.periodo;
  }).map(function (val) {
    return periodo.filter(function (row) {
      return row.periodo === val;
    });
  });
  var getMapRanges = R.isEmpty(matchingDataPeriodo) ? [] : mapRanges(R.head(matchingDataPeriodo));
  var resultList = getMapRanges.map(function (range) {
    return getSelectedRange[0].overlaps(range);
  });
  return R.any(R.equals(true), resultList) ? (0, _sanctuary.Left)([periodoErrorMsg]) : (0, _sanctuary.Right)(modalData);
};

var excludesPrimaryKey = R.curry(function (tableData, modalData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg) {
  return tableData.filter(checkPrimaryKey({
    row: modalData.row,
    pks: pks
  })).length > 0 ? (0, _sanctuary.Left)([errMsg]) : periodiRangeOverlapChecker({
    tableData: tableData,
    modalData: modalData,
    selectedPeriodo: modalData.row.periodo,
    periodo: periodo,
    periodoKeys: periodoKeys,
    periodoErrorMsg: periodoErrorMsg
  });
});

var primaryKeyValuesMatch = function primaryKeyValuesMatch(modalData, pks, errMsg) {
  return R.all(function (x) {
    return R.equals(modalData.row[x], modalData.orig[x]);
  }, pks) ? (0, _sanctuary.Right)(modalData) : (0, _sanctuary.Left)([errMsg]);
};

var onlyNonPrimaryAltered = function onlyNonPrimaryAltered(modalData, pks, errMsg) {
  return R.pipe(function (x) {
    return primaryKeyValuesMatch(x, pks, errMsg);
  }, R.chain(function (x) {
    return nonPrimaryKeyValuesAltered(x, pks, errMsg);
  }))(modalData);
};

var addOrUpdate = function addOrUpdate(tableData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg) {
  return function (modalData) {
    return (0, _commitModsHelper.sanctuaryConcat)(excludesPrimaryKey(tableData, modalData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg), onlyNonPrimaryAltered(modalData, pks, errMsg));
  };
};

var isUpdate = R.ifElse(R.propEq("type", "Update Mapping"), _sanctuary.Right, R.always((0, _sanctuary.Left)([])));
var getUpdater = (0, _commitModsHelper.reader)(function (_ref3) {
  var pks = _ref3.pks,
      errMsg = _ref3.errMsg,
      modalData = _ref3.modalData,
      tableData = _ref3.tableData,
      periodo = _ref3.periodo,
      periodoKeys = _ref3.periodoKeys,
      periodoErrorMsg = _ref3.periodoErrorMsg;
  return R.pipe(isUpdate, R.chain(addOrUpdate(tableData, pks, errMsg, periodo, periodoKeys, periodoErrorMsg)), R.map(function (m) {
    return R.assoc("mod", m.type, m.row);
  }), R.map(R.assoc("original", modalData.orig.original || modalData.orig)), R.map(function (updated) {
    return alterMatch(R.always(updated), tableData, modalData.orig, pks);
  }))(modalData);
});
var isAdd = R.ifElse(R.propEq("type", "Add Mapping"), _sanctuary.Right, R.always((0, _sanctuary.Left)([])));
var getAdder = (0, _commitModsHelper.reader)(function (_ref4) {
  var pks = _ref4.pks,
      errMsg = _ref4.errMsg,
      modalData = _ref4.modalData,
      tableData = _ref4.tableData,
      periodo = _ref4.periodo,
      periodoKeys = _ref4.periodoKeys,
      periodoErrorMsg = _ref4.periodoErrorMsg;
  return R.pipe(isAdd, R.chain(function (x) {
    return excludesPrimaryKey(tableData, x, pks, errMsg, periodo, periodoKeys, periodoErrorMsg);
  }), R.map(function (m) {
    return R.assoc("mod", m.type, m.row);
  }), R.map(function (x) {
    return R.prepend(x, tableData);
  }))(modalData);
});
var getModifiers = R.traverse(_commitModsHelper.reader.of, R.identity, [getUpdater, getAdder]).map(R.apply(_sanctuary.concat));

var commitPeriodiModification = function commitPeriodiModification(_ref5) {
  var pks = _ref5.pks,
      errMsg = _ref5.errMsg,
      modalData = _ref5.modalData,
      tableData = _ref5.tableData,
      periodo = _ref5.periodo,
      periodoKeys = _ref5.periodoKeys,
      periodoErrorMsg = _ref5.periodoErrorMsg;
  return getModifiers.run({
    pks: pks,
    errMsg: errMsg,
    modalData: modalData,
    tableData: tableData,
    periodo: periodo,
    periodoKeys: periodoKeys,
    periodoErrorMsg: periodoErrorMsg
  });
};

exports.commitPeriodiModification = commitPeriodiModification;
var _default = commitPeriodiModification;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9tYXBwaW5nVG9vbHMvY29tbWl0UGVyaW9kaU1vZGlmaWNhdGlvbi50cyJdLCJuYW1lcyI6WyJjaGVja1ByaW1hcnlLZXkiLCJyb3ciLCJwa3MiLCJSIiwiYWxsUGFzcyIsIm1hcCIsImVxUHJvcHMiLCJhbHRlck1hdGNoIiwiY3VycnkiLCJmbiIsInN0YXRlIiwiaWZFbHNlIiwiaWRlbnRpdHkiLCJub25QcmltYXJ5S2V5VmFsdWVzQWx0ZXJlZCIsIm1vZGFsRGF0YSIsImVyck1zZyIsImVxdWFscyIsIm9taXQiLCJvcmlnIiwibWFwUmFuZ2VzIiwibGlzdCIsInJhbmdlIiwidmFsaWRvRGFsIiwiZm9ybWF0IiwidmFsaWRvQWwiLCJwZXJpb2RpUmFuZ2VPdmVybGFwQ2hlY2tlciIsInRhYmxlRGF0YSIsInNlbGVjdGVkUGVyaW9kbyIsInBlcmlvZG8iLCJwZXJpb2RvS2V5cyIsInBlcmlvZG9FcnJvck1zZyIsImdldFNlbGVjdGVkUmFuZ2UiLCJmaWx0ZXIiLCJ4IiwibWF0Y2hpbmdEYXRhUGVyaW9kbyIsInZhbCIsImdldE1hcFJhbmdlcyIsImlzRW1wdHkiLCJoZWFkIiwicmVzdWx0TGlzdCIsIm92ZXJsYXBzIiwiYW55IiwiZXhjbHVkZXNQcmltYXJ5S2V5IiwibGVuZ3RoIiwicHJpbWFyeUtleVZhbHVlc01hdGNoIiwiYWxsIiwib25seU5vblByaW1hcnlBbHRlcmVkIiwicGlwZSIsImNoYWluIiwiYWRkT3JVcGRhdGUiLCJpc1VwZGF0ZSIsInByb3BFcSIsIlJpZ2h0IiwiYWx3YXlzIiwiZ2V0VXBkYXRlciIsIm0iLCJhc3NvYyIsInR5cGUiLCJvcmlnaW5hbCIsInVwZGF0ZWQiLCJpc0FkZCIsImdldEFkZGVyIiwicHJlcGVuZCIsImdldE1vZGlmaWVycyIsInRyYXZlcnNlIiwicmVhZGVyIiwib2YiLCJhcHBseSIsImNvbmNhdCIsImNvbW1pdFBlcmlvZGlNb2RpZmljYXRpb24iLCJydW4iXSwibWFwcGluZ3Mi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QSxTQUhlO0FBSWZZLElBQUFBLFNBQVMsRUFBVEEsU0FKZTtBQUtmRSxJQUFBQSxPQUFPLEVBQVBBLE9BTGU7QUFNZkMsSUFBQUEsV0FBVyxFQUFYQSxXQU5lO0FBT2ZDLElBQUFBLGVBQWUsRUFBZkE7QUFQZSxHQUFqQixDQWpCdUM7QUFBQSxDQUFsQzs7O2VBMkJRdUMseUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBSIGZyb20gXCJyYW1kYVwiO1xyXG5pbXBvcnQgeyBMZWZ0LCBSaWdodCwgY29uY2F0IH0gZnJvbSBcInNhbmN0dWFyeVwiO1xyXG5pbXBvcnQgeyByZWFkZXIsIHNhbmN0dWFyeUNvbmNhdCwgbW9tZW50IH0gZnJvbSBcIi4vY29tbWl0TW9kc0hlbHBlclwiO1xyXG5cclxuY29uc3QgY2hlY2tQcmltYXJ5S2V5ID0gKHsgcm93LCBwa3MgfTogeyByb3c6IGFueTsgcGtzOiBhbnkgfSk6IGFueSA9PlxyXG4gIFIuYWxsUGFzcyhSLm1hcChSLmVxUHJvcHMsIHBrcykpKHJvdyk7XHJcblxyXG5jb25zdCBhbHRlck1hdGNoID0gUi5jdXJyeSgoZm46IGFueSwgc3RhdGU6IGFueSwgcm93OiBhbnksIHBrczogYW55KSA9PlxyXG4gIFIubWFwKFIuaWZFbHNlKGNoZWNrUHJpbWFyeUtleSh7IHJvdywgcGtzIH0pLCBmbiwgUi5pZGVudGl0eSksIHN0YXRlKVxyXG4pO1xyXG5cclxuY29uc3Qgbm9uUHJpbWFyeUtleVZhbHVlc0FsdGVyZWQgPSAoXHJcbiAgbW9kYWxEYXRhOiBhbnksXHJcbiAgcGtzOiBhbnksXHJcbiAgZXJyTXNnOiBzdHJpbmdcclxuKTogYW55ID0+XHJcbiAgUi5lcXVhbHMoUi5vbWl0KHBrcywgbW9kYWxEYXRhLnJvdyksIFIub21pdChwa3MsIG1vZGFsRGF0YS5vcmlnKSlcclxuICAgID8gTGVmdChlcnJNc2cpXHJcbiAgICA6IFJpZ2h0KG1vZGFsRGF0YSk7XHJcblxyXG5jb25zdCBtYXBSYW5nZXMgPSAobGlzdDogYW55KSA9PlxyXG4gIGxpc3QubWFwKChyb3c6IGFueSkgPT5cclxuICAgIG1vbWVudCgpLnJhbmdlKFxyXG4gICAgICBtb21lbnQocm93LnZhbGlkb0RhbCkuZm9ybWF0KFwiWVlZWS1NTS1ERFwiKSxcclxuICAgICAgbW9tZW50KHJvdy52YWxpZG9BbCkuZm9ybWF0KFwiWVlZWS1NTS1ERFwiKVxyXG4gICAgKVxyXG4gICk7XHJcblxyXG5jb25zdCBwZXJpb2RpUmFuZ2VPdmVybGFwQ2hlY2tlciA9ICh7XHJcbiAgdGFibGVEYXRhLFxyXG4gIG1vZGFsRGF0YSxcclxuICBzZWxlY3RlZFBlcmlvZG8sXHJcbiAgcGVyaW9kbyxcclxuICBwZXJpb2RvS2V5cyxcclxuICBwZXJpb2RvRXJyb3JNc2dcclxufToge1xyXG4gIHRhYmxlRGF0YTogYW55O1xyXG4gIG1vZGFsRGF0YTogYW55O1xyXG4gIHNlbGVjdGVkUGVyaW9kbzogYW55O1xyXG4gIHBlcmlvZG86IGFueTtcclxuICBwZXJpb2RvS2V5czogYW55O1xyXG4gIHBlcmlvZG9FcnJvck1zZzogYW55O1xyXG59KSA9PiB7XHJcbiAgY29uc3QgZ2V0U2VsZWN0ZWRSYW5nZSA9IHBlcmlvZG9cclxuICAgIC5maWx0ZXIoKHJvdzogYW55KSA9PiByb3cucGVyaW9kbyA9PT0gc2VsZWN0ZWRQZXJpb2RvKVxyXG4gICAgLm1hcCgoeDogYW55KSA9PiBtb21lbnQoKS5yYW5nZSh4LnZhbGlkb0RhbCwgeC52YWxpZG9BbCkpO1xyXG5cclxuICBjb25zdCBtYXRjaGluZ0RhdGFQZXJpb2RvID0gdGFibGVEYXRhXHJcbiAgICAuZmlsdGVyKGNoZWNrUHJpbWFyeUtleSh7IHJvdzogbW9kYWxEYXRhLnJvdywgcGtzOiBwZXJpb2RvS2V5cyB9KSlcclxuICAgIC5tYXAoKHg6IGFueSkgPT4geC5wZXJpb2RvKVxyXG4gICAgLm1hcCgodmFsOiBhbnkpID0+IHBlcmlvZG8uZmlsdGVyKHJvdyA9PiByb3cucGVyaW9kbyA9PT0gdmFsKSk7XHJcblxyXG4gIGNvbnN0IGdldE1hcFJhbmdlcyA9IFIuaXNFbXB0eShtYXRjaGluZ0RhdGFQZXJpb2RvKVxyXG4gICAgPyBbXVxyXG4gICAgOiBtYXBSYW5nZXMoUi5oZWFkKG1hdGNoaW5nRGF0YVBlcmlvZG8pKTtcclxuXHJcbiAgY29uc3QgcmVzdWx0TGlzdCA9IGdldE1hcFJhbmdlcy5tYXAoKHJhbmdlOiBhbnkpID0+XHJcbiAgICBnZXRTZWxlY3RlZFJhbmdlWzBdLm92ZXJsYXBzKHJhbmdlKVxyXG4gICk7XHJcblxyXG4gIHJldHVybiBSLmFueShSLmVxdWFscyh0cnVlKSwgcmVzdWx0TGlzdClcclxuICAgID8gTGVmdChbcGVyaW9kb0Vycm9yTXNnXSlcclxuICAgIDogUmlnaHQobW9kYWxEYXRhKTtcclxufTtcclxuXHJcbmNvbnN0IGV4Y2x1ZGVzUHJpbWFyeUtleSA9IFIuY3VycnkoXHJcbiAgKFxyXG4gICAgdGFibGVEYXRhOiBhbnksXHJcbiAgICBtb2RhbERhdGE6IGFueSxcclxuICAgIHBrczogYW55LFxyXG4gICAgZXJyTXNnOiBzdHJpbmcsXHJcbiAgICBwZXJpb2RvOiBhbnksXHJcbiAgICBwZXJpb2RvS2V5czogYW55LFxyXG4gICAgcGVyaW9kb0Vycm9yTXNnOiBhbnlcclxuICApOiBhbnkgPT5cclxuICAgIHRhYmxlRGF0YS5maWx0ZXIoY2hlY2tQcmltYXJ5S2V5KHsgcm93OiBtb2RhbERhdGEucm93LCBwa3MgfSkpLmxlbmd0aCA+IDBcclxuICAgICAgPyBMZWZ0KFtlcnJNc2ddKVxyXG4gICAgICA6IHBlcmlvZGlSYW5nZU92ZXJsYXBDaGVja2VyKHtcclxuICAgICAgICAgIHRhYmxlRGF0YSxcclxuICAgICAgICAgIG1vZGFsRGF0YSxcclxuICAgICAgICAgIHNlbGVjdGVkUGVyaW9kbzogbW9kYWxEYXRhLnJvdy5wZXJpb2RvLFxyXG4gICAgICAgICAgcGVyaW9kbyxcclxuICAgICAgICAgIHBlcmlvZG9LZXlzLFxyXG4gICAgICAgICAgcGVyaW9kb0Vycm9yTXNnXHJcbiAgICAgICAgfSlcclxuKTtcclxuXHJcbmNvbnN0IHByaW1hcnlLZXlWYWx1ZXNNYXRjaCA9IChtb2RhbERhdGE6IGFueSwgcGtzOiBhbnksIGVyck1zZzogc3RyaW5nKTogYW55ID0+XHJcbiAgUi5hbGwoKHg6IGFueSkgPT4gUi5lcXVhbHMobW9kYWxEYXRhLnJvd1t4XSwgbW9kYWxEYXRhLm9yaWdbeF0pLCBwa3MpXHJcbiAgICA/IFJpZ2h0KG1vZGFsRGF0YSlcclxuICAgIDogTGVmdChbZXJyTXNnXSk7XHJcblxyXG5jb25zdCBvbmx5Tm9uUHJpbWFyeUFsdGVyZWQgPSAobW9kYWxEYXRhOiBhbnksIHBrczogYW55LCBlcnJNc2c6IHN0cmluZykgPT5cclxuICBSLnBpcGUoXHJcbiAgICAoeDogYW55KSA9PiBwcmltYXJ5S2V5VmFsdWVzTWF0Y2goeCwgcGtzLCBlcnJNc2cpLFxyXG4gICAgUi5jaGFpbih4ID0+IG5vblByaW1hcnlLZXlWYWx1ZXNBbHRlcmVkKHgsIHBrcywgZXJyTXNnKSlcclxuICApKG1vZGFsRGF0YSk7XHJcblxyXG5jb25zdCBhZGRPclVwZGF0ZSA9IChcclxuICB0YWJsZURhdGE6IGFueSxcclxuICBwa3M6IGFueSxcclxuICBlcnJNc2c6IHN0cmluZyxcclxuICBwZXJpb2RvOiBhbnksXHJcbiAgcGVyaW9kb0tleXM6IGFueSxcclxuICBwZXJpb2RvRXJyb3JNc2c6IGFueVxyXG4pOiBhbnkgPT4gKG1vZGFsRGF0YTogYW55KSA9PlxyXG4gIHNhbmN0dWFyeUNvbmNhdChcclxuICAgIGV4Y2x1ZGVzUHJpbWFyeUtleShcclxuICAgICAgdGFibGVEYXRhLFxyXG4gICAgICBtb2RhbERhdGEsXHJcbiAgICAgIHBrcyxcclxuICAgICAgZXJyTXNnLFxyXG4gICAgICBwZXJpb2RvLFxyXG4gICAgICBwZXJpb2RvS2V5cyxcclxuICAgICAgcGVyaW9kb0Vycm9yTXNnXHJcbiAgICApLFxyXG4gICAgb25seU5vblByaW1hcnlBbHRlcmVkKG1vZGFsRGF0YSwgcGtzLCBlcnJNc2cpXHJcbiAgKTtcclxuXHJcbmNvbnN0IGlzVXBkYXRlID0gUi5pZkVsc2UoXHJcbiAgUi5wcm9wRXEoXCJ0eXBlXCIsIFwiVXBkYXRlIE1hcHBpbmdcIiksXHJcbiAgUmlnaHQsXHJcbiAgUi5hbHdheXMoTGVmdChbXSkpXHJcbik7XHJcblxyXG5jb25zdCBnZXRVcGRhdGVyID0gcmVhZGVyKFxyXG4gICh7XHJcbiAgICBwa3MsXHJcbiAgICBlcnJNc2csXHJcbiAgICBtb2RhbERhdGEsXHJcbiAgICB0YWJsZURhdGEsXHJcbiAgICBwZXJpb2RvLFxyXG4gICAgcGVyaW9kb0tleXMsXHJcbiAgICBwZXJpb2RvRXJyb3JNc2dcclxuICB9OiB7XHJcbiAgICBwa3M6IGFueTtcclxuICAgIGVyck1zZzogc3RyaW5nO1xyXG4gICAgbW9kYWxEYXRhOiBhbnk7XHJcbiAgICB0YWJsZURhdGE6IGFueTtcclxuICAgIHBlcmlvZG86IGFueTtcclxuICAgIHBlcmlvZG9LZXlzOiBhbnk7XHJcbiAgICBwZXJpb2RvRXJyb3JNc2c6IGFueTtcclxuICB9KSA9PlxyXG4gICAgUi5waXBlKFxyXG4gICAgICBpc1VwZGF0ZSxcclxuICAgICAgUi5jaGFpbihcclxuICAgICAgICBhZGRPclVwZGF0ZShcclxuICAgICAgICAgIHRhYmxlRGF0YSxcclxuICAgICAgICAgIHBrcyxcclxuICAgICAgICAgIGVyck1zZyxcclxuICAgICAgICAgIHBlcmlvZG8sXHJcbiAgICAgICAgICBwZXJpb2RvS2V5cyxcclxuICAgICAgICAgIHBlcmlvZG9FcnJvck1zZ1xyXG4gICAgICAgIClcclxuICAgICAgKSxcclxuICAgICAgUi5tYXAoKG06IGFueSkgPT4gUi5hc3NvYyhcIm1vZFwiLCBtLnR5cGUsIG0ucm93KSksXHJcbiAgICAgIFIubWFwKFIuYXNzb2MoXCJvcmlnaW5hbFwiLCBtb2RhbERhdGEub3JpZy5vcmlnaW5hbCB8fCBtb2RhbERhdGEub3JpZykpLFxyXG4gICAgICBSLm1hcCh1cGRhdGVkID0+XHJcbiAgICAgICAgYWx0ZXJNYXRjaChSLmFsd2F5cyh1cGRhdGVkKSwgdGFibGVEYXRhLCBtb2RhbERhdGEub3JpZywgcGtzKVxyXG4gICAgICApXHJcbiAgICApKG1vZGFsRGF0YSlcclxuKTtcclxuXHJcbmNvbnN0IGlzQWRkID0gUi5pZkVsc2UoXHJcbiAgUi5wcm9wRXEoXCJ0eXBlXCIsIFwiQWRkIE1hcHBpbmdcIiksXHJcbiAgUmlnaHQsXHJcbiAgUi5hbHdheXMoTGVmdChbXSkpXHJcbik7XHJcbmNvbnN0IGdldEFkZGVyID0gcmVhZGVyKFxyXG4gICh7XHJcbiAgICBwa3MsXHJcbiAgICBlcnJNc2csXHJcbiAgICBtb2RhbERhdGEsXHJcbiAgICB0YWJsZURhdGEsXHJcbiAgICBwZXJpb2RvLFxyXG4gICAgcGVyaW9kb0tleXMsXHJcbiAgICBwZXJpb2RvRXJyb3JNc2dcclxuICB9OiB7XHJcbiAgICBwa3M6IGFueTtcclxuICAgIGVyck1zZzogc3RyaW5nO1xyXG4gICAgbW9kYWxEYXRhOiBhbnk7XHJcbiAgICB0YWJsZURhdGE6IGFueTtcclxuICAgIHBlcmlvZG86IGFueTtcclxuICAgIHBlcmlvZG9LZXlzOiBhbnk7XHJcbiAgICBwZXJpb2RvRXJyb3JNc2c6IGFueTtcclxuICB9KSA9PlxyXG4gICAgUi5waXBlKFxyXG4gICAgICBpc0FkZCxcclxuICAgICAgUi5jaGFpbih4ID0+XHJcbiAgICAgICAgZXhjbHVkZXNQcmltYXJ5S2V5KFxyXG4gICAgICAgICAgdGFibGVEYXRhLFxyXG4gICAgICAgICAgeCxcclxuICAgICAgICAgIHBrcyxcclxuICAgICAgICAgIGVyck1zZyxcclxuICAgICAgICAgIHBlcmlvZG8sXHJcbiAgICAgICAgICBwZXJpb2RvS2V5cyxcclxuICAgICAgICAgIHBlcmlvZG9FcnJvck1zZ1xyXG4gICAgICAgIClcclxuICAgICAgKSxcclxuICAgICAgUi5tYXAoKG06IGFueSkgPT4gUi5hc3NvYyhcIm1vZFwiLCBtLnR5cGUsIG0ucm93KSksXHJcbiAgICAgIFIubWFwKHggPT4gUi5wcmVwZW5kKHgsIHRhYmxlRGF0YSkpXHJcbiAgICApKG1vZGFsRGF0YSlcclxuKTtcclxuY29uc3QgZ2V0TW9kaWZpZXJzID0gUi50cmF2ZXJzZTxhbnksIGFueSwgYW55PihyZWFkZXIub2YsIFIuaWRlbnRpdHksIFtcclxuICBnZXRVcGRhdGVyLFxyXG4gIGdldEFkZGVyXHJcbl0pLm1hcChSLmFwcGx5KGNvbmNhdCkpO1xyXG5cclxuZXhwb3J0IGNvbnN0IGNvbW1pdFBlcmlvZGlNb2RpZmljYXRpb24gPSAoe1xyXG4gIHBrcyxcclxuICBlcnJNc2csXHJcbiAgbW9kYWxEYXRhLFxyXG4gIHRhYmxlRGF0YSxcclxuICBwZXJpb2RvLFxyXG4gIHBlcmlvZG9LZXlzLFxyXG4gIHBlcmlvZG9FcnJvck1zZ1xyXG59OiB7XHJcbiAgcGtzOiBhbnk7XHJcbiAgZXJyTXNnOiBzdHJpbmc7XHJcbiAgbW9kYWxEYXRhOiBhbnk7XHJcbiAgdGFibGVEYXRhOiBhbnk7XHJcbiAgcGVyaW9kbzogYW55O1xyXG4gIHBlcmlvZG9LZXlzOiBhbnk7XHJcbiAgcGVyaW9kb0Vycm9yTXNnOiBhbnk7XHJcbn0pID0+XHJcbiAgZ2V0TW9kaWZpZXJzLnJ1bih7XHJcbiAgICBwa3MsXHJcbiAgICBlcnJNc2csXHJcbiAgICBtb2RhbERhdGEsXHJcbiAgICB0YWJsZURhdGEsXHJcbiAgICBwZXJpb2RvLFxyXG4gICAgcGVyaW9kb0tleXMsXHJcbiAgICBwZXJpb2RvRXJyb3JNc2dcclxuICB9KTtcclxuXHJcbmV4cG9ydCBkZWZhdWx0IGNvbW1pdFBlcmlvZGlNb2RpZmljYXRpb247XHJcbiJdfQ==